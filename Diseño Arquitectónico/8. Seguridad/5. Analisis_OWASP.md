# Análisis Exhaustivo de Riesgos y Mitigación - OWASP
**Proyecto:** Plataforma de Gestión de Proveedores - Indurama
**Arquitectura:** Serverless (Firebase) + React Native

## 1. Introducción y Alcance
Este documento responde a la solicitud de los arquitectos de seguridad para el análisis previo al desarrollo del Backend. Se detalla la estrategia de defensa en profundidad basada en los estándares **OWASP Top 10 (2021)** para la infraestructura web/API y **OWASP Mobile Application Security Verification Standard (MASVS)** para el aplicativo móvil.

El objetivo es demostrar cómo la arquitectura **JESKI Tech** mitiga proactivamente los vectores de ataque más críticos mediante controles de seguridad nativos y prácticas de codificación segura.

---

## 2. Análisis OWASP Top 10 (Backend & API)

A continuación, se desglosan los 10 riesgos críticos de seguridad web, analizando su impacto específico en el negocio de Indurama y la solución técnica implementada.

### A01: Broken Access Control (Fallas de Control de Acceso)
> **Definición:** Ocurre cuando las restricciones sobre lo que los usuarios autenticados pueden hacer no se aplican correctamente.
* **Escenario de Riesgo (Indurama):** Un proveedor malintencionado intenta acceder a la URL de una cotización de su competencia modificando el `id_cotizacion` en la API, o un usuario estándar intenta acceder a funciones de administración.
* **Estrategia de Mitigación (JESKI Tech):**
    1.  **Modelo de Permisos de Mínimo Privilegio:** Implementación de reglas estrictas en **Firestore Security Rules**. Ninguna consulta es pública.
    2.  **Validación de Propiedad:** Regla técnica `allow read, write: if request.auth.uid == resource.data.proveedor_id;`. Esto asegura matemáticamente que un usuario solo pueda leer documentos que le pertenecen explícitamente.
    3.  **Roles Inmutables:** Uso de **Custom Claims** en el token JWT de Firebase Auth (`admin: true`, `proveedor: true`). Estos roles se definen en funciones backend seguras y no pueden ser modificados por el cliente frontend.

### A02: Cryptographic Failures (Fallas Criptográficas)
> **Definición:** Protección inadecuada de datos sensibles en tránsito o reposo.
* **Escenario de Riesgo (Indurama):** Interceptación de datos bancarios de proveedores en redes WiFi públicas o robo de la base de datos física.
* **Estrategia de Mitigación (JESKI Tech):**
    1.  **En Tránsito:** Forzado de **HTTPS (TLS 1.2 o superior)** en todas las interacciones con Cloud Functions y Firestore. Firebase Hosting provee certificados SSL gestionados automáticamente, eliminando el error humano en la configuración de certificados.
    2.  **En Reposo:** La infraestructura de Google Cloud cifra automáticamente todos los datos escritos en disco utilizando el estándar **AES-256**, sin impacto en el rendimiento.

### A03: Injection (Inyección)
> **Definición:** Envío de datos hostiles a un intérprete (SQL, NoSQL, OS) que resultan en la ejecución de comandos no deseados.
* **Escenario de Riesgo (Indurama):** Un atacante inyecta comandos NoSQL en el campo de búsqueda de proveedores para intentar descargar toda la base de datos de usuarios.
* **Estrategia de Mitigación (JESKI Tech):**
    1.  **Abstracción de Consultas:** Al utilizar los SDKs cliente de Firebase y Cloud Firestore, las consultas no se construyen concatenando cadenas (como en SQL dinámico). El SDK trata todos los inputs como datos literales, no como código ejecutable.
    2.  **Validación de Tipos:** Las reglas de seguridad validan el tipo de dato de entrada (`is number`, `is string`) antes de procesar la escritura, rechazando cualquier payload malicioso que no cumpla con el esquema.

### A04: Insecure Design (Diseño Inseguro)
> **Definición:** Riesgos relacionados con fallas en el diseño y la arquitectura, no solo en la implementación.
* **Escenario de Riesgo (Indurama):** Lógica de negocio que permite saltarse pasos en la aprobación de un proveedor (ej. aprobar sin validar documentos fiscales).
* **Estrategia de Mitigación (JESKI Tech):**
    1.  **Threat Modeling:** Uso de diagramas de secuencia y casos de uso para identificar flujos críticos antes de codificar.
    2.  **Validación de Estado en Backend:** Las Cloud Functions que cambian el estado de un proveedor (de "Pendiente" a "Aprobado") verifican independientemente que todos los requisitos previos (documentos cargados) se cumplan, ignorando cualquier validación que el Frontend haya realizado.

### A05: Security Misconfiguration (Mala Configuración de Seguridad)
> **Definición:** Configuraciones por defecto inseguras, almacenamiento en la nube abierto, mensajes de error detallados.
* **Escenario de Riesgo (Indurama):** Dejar un bucket de Cloud Storage con permisos públicos ("read: all") exponiendo los RUCs y PDFs de todos los proveedores.
* **Estrategia de Mitigación (JESKI Tech):**
    1.  **Infraestructura como Código:** Las reglas de seguridad (`firestore.rules`, `storage.rules`) se versionan en Git y se despliegan automáticamente mediante el pipeline de CI/CD, evitando cambios manuales y errores en la consola.
    2.  **Principio de "Deny by Default":** Las reglas de seguridad comienzan bloqueando todo el acceso (`allow read, write: if false;`) y se abren permisos específicos solo cuando es necesario.

### A06: Vulnerable and Outdated Components (Componentes Vulnerables)
> **Definición:** Uso de librerías y dependencias con vulnerabilidades conocidas (CVEs).
* **Escenario de Riesgo (Indurama):** Uso de una versión antigua de una librería de procesamiento de imágenes en Node.js que permite ejecución remota de código.
* **Estrategia de Mitigación (JESKI Tech):**
    1.  **Escaneo Automatizado:** Integración de `npm audit` en el pipeline de CI/CD para bloquear el despliegue si se detectan vulnerabilidades críticas.
    2.  **Mantenimiento Serverless:** Al usar Cloud Functions, Google gestiona y parchea el sistema operativo subyacente y el entorno de ejecución de Node.js, reduciendo la superficie de ataque que el equipo debe administrar.

### A07: Identification and Authentication Failures (Fallas de Identificación)
> **Definición:** Debilidades en la confirmación de la identidad, gestión de sesiones y contraseñas.
* **Escenario de Riesgo (Indurama):** Ataques de fuerza bruta o "Credential Stuffing" contra cuentas de gestores.
* **Estrategia de Mitigación (JESKI Tech):**
    1.  **Delegación a Expertos:** No implementamos criptografía de contraseñas propia. Utilizamos **Firebase Authentication**, que incluye algoritmos de hash robustos (scrypt) y protección automática contra ataques de fuerza bruta (bloqueo temporal de IPs sospechosas).
    2.  **Tokens de Vida Corta:** Los tokens de acceso (JWT) tienen una expiración de 1 hora, minimizando la ventana de oportunidad en caso de robo de sesión.

### A08: Software and Data Integrity Failures (Fallas de Integridad)
> **Definición:** Código e infraestructura que no protegen contra violaciones de integridad (ej. actualizaciones inseguras).
* **Escenario de Riesgo (Indurama):** Un atacante clona la App, elimina las validaciones de seguridad y la distribuye para atacar la API.
* **Estrategia de Mitigación (JESKI Tech):**
    1.  **Firebase App Check:** Implementación de atestación de dispositivo. El Backend rechaza cualquier petición que no provenga de una instancia legítima y firmada de la App (verificada vía Google Play Integrity API).

### A09: Security Logging and Monitoring (Monitoreo y Registro)
> **Definición:** Falta de detección, escalado y respuesta ante incidentes activos.
* **Escenario de Riesgo (Indurama):** Un ataque de fuerza bruta ocurre durante 4 horas y nadie se entera hasta que los datos son robados.
* **Estrategia de Mitigación (JESKI Tech):**
    1.  **Centralización de Logs:** Uso de **Google Cloud Logging** para auditar todas las invocaciones a Cloud Functions y errores de seguridad.
    2.  **Alertas en Tiempo Real:** Integración de **Crashlytics** y webhooks a canales de Discord/Slack del equipo DevOps para notificar anomalías críticas inmediatamente.

### A10: Server-Side Request Forgery (SSRF)
> **Definición:** El servidor es inducido a realizar peticiones a recursos internos o externos no deseados.
* **Escenario de Riesgo (Indurama):** Manipulación de una función de "carga de imagen por URL" para escanear puertos internos de la infraestructura de Google.
* **Estrategia de Mitigación (JESKI Tech):**
    1.  **Entorno Aislado:** Cloud Functions se ejecutan en entornos aislados.
    2.  **Validación de Salida:** Se restringen las llamadas externas únicamente a dominios permitidos (Whitelisting) dentro de la lógica de negocio, y se validan estrictamente las URLs proporcionadas por el usuario antes de procesarlas.

---

## 3. Seguridad en Aplicaciones Móviles (Estándar OWASP MASVS)

Para la aplicación móvil desarrollada en **React Native**, alineamos los controles con el **Mobile App Security Verification Standard (MASVS)** Nivel 1 (Seguridad Estándar) y componentes del Nivel 2 (Defensa en Profundidad).

### MASVS-STORAGE: Almacenamiento Seguro
* **Requerimiento:** No almacenar datos sensibles sin cifrar en el dispositivo.
* **Implementación JESKI:**
    * No utilizamos `AsyncStorage` para guardar tokens de sesión o datos personales, ya que no es seguro.
    * Utilizamos el SDK de Firebase Auth que almacena automáticamente el token de refresco en el **Keystore (Android)**, aprovechando el hardware de seguridad del dispositivo.

### MASVS-CRYPTO: Criptografía
* **Requerimiento:** Uso de algoritmos estándar y gestión segura de llaves.
* **Implementación JESKI:**
    * No implementamos algoritmos propios ("Roll your own crypto").
    * Delegamos todas las operaciones criptográficas a las APIs del sistema operativo a través de librerías nativas probadas.

### MASVS-AUTH: Autenticación Local
* **Requerimiento:** La autenticación debe realizarse en el servidor, no localmente.
* **Implementación JESKI:**
    * La App no toma decisiones de seguridad por sí sola. Un "login exitoso" en la UI no otorga acceso a datos; el acceso real depende de que el token JWT enviado al servidor sea válido y tenga los Claims correctos.

### MASVS-NETWORK: Comunicación de Red
* **Requerimiento:** Comunicaciones seguras y validadas.
* **Implementación JESKI:**
    * **Traffic Encryption:** Todo el tráfico es HTTPS.
    * **Cleartext Traffic Disabled:** En la configuración de Android (`AndroidManifest.xml`), deshabilitamos explícitamente el tráfico de texto plano (`android:usesCleartextTraffic="false"`), impidiendo conexiones HTTP accidentales.

### MASVS-PLATFORM: Interacción con la Plataforma
* **Requerimiento:** Uso seguro de permisos y componentes de Android.
* **Implementación JESKI:**
    * **Permisos Mínimos:** Solicitamos solo los permisos estrictamente necesarios (Cámara para evidencias, Internet para conexión). No solicitamos acceso a contactos ni SMS.
    * **Exported Components:** Aseguramos que los componentes internos de la App no estén exportados (`android:exported="false"`) para evitar que otras apps maliciosas en el mismo teléfono los invoquen.

### MASVS-CODE: Calidad del Código
* **Requerimiento:** La App debe estar firmada y libre de depuración en producción.
* **Implementación JESKI:**
    * El proceso de **Build en Expo EAS** elimina automáticamente el código de depuración y logs (`console.log`) en la versión de producción.
    * La APK final es firmada con una llave de producción gestionada seguramente por Google Play Console.
